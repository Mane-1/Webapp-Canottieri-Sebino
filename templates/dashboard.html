<!-- templates/dashboard.html -->
{% extends "layout/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-5">
    <h1 class="display-5 fw-bold">Ciao, {{ current_user.first_name or current_user.username }}!</h1>
    <p class="col-lg-8 fs-4">Usa i collegamenti qua sotto per accedere alle varie sezioni della Webapp. Di seguito i tuoi prossimi eventi:</p>

    <div class="mb-4">
        {% if events %}
            {% for ev in events %}
                {% if ev.type == 'allenamento' %}
                <div class="dashboard-event p-2 mb-2 rounded text-white d-flex justify-content-between align-items-center"
                     style="background-color: {{ ev.color }};"
                     data-type="allenamento"
                     data-id="{{ ev.id }}"
                     data-title="{{ ev.title }}"
                     data-date="{{ ev.date.strftime('%A %d/%m') }}"
                     data-time="{{ ev.start.strftime('%H:%M') }}{% if ev.end %} - {{ ev.end.strftime('%H:%M') }}{% endif %}"
                     data-start="{{ ev.start.isoformat() }}"
                     data-description="{{ ev.description }}"
                     data-categories="{{ ev.categories }}"
                     data-coaches="{{ ev.coaches }}"
                     data-recurrence="{{ ev.recurrence }}"
                     data-status="{{ ev.status }}">
                    <span class="fw-semibold">{{ ev.title }}</span>
                    <span>{{ ev.date.strftime('%d/%m/%Y') }} - {{ ev.start.strftime('%H:%M') }}{% if ev.end %} - {{ ev.end.strftime('%H:%M') }}{% endif %}</span>
                </div>
                {% else %}
                <div class="dashboard-event p-3 mb-2 border border-info border-2 rounded d-flex justify-content-between align-items-center"
                     data-link="/turni"
                     style="cursor: pointer;"
                     data-type="turno"
                     data-id="{{ ev.id }}"
                     data-title="Turno {{ ev.fascia }}"
                     data-date="{{ ev.date.strftime('%A %d/%m') }}"
                     data-time="{{ ev.start.strftime('%H:%M') }}{% if ev.end %} - {{ ev.end.strftime('%H:%M') }}{% endif %}"
                     data-start="{{ ev.start.isoformat() }}"
                     data-description="Turno {{ ev.fascia }}"
                     data-categories="-"
                     data-coaches="-"
                     data-recurrence="No">
                    <span class="fw-bold">{{ ev.date.strftime('%d/%m/%Y') }} - {{ ev.fascia }}</span>
                    <span>üïí {{ ev.start.strftime('%H:%M') }}{% if ev.end %} - {{ ev.end.strftime('%H:%M') }}{% endif %}</span>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
        <p class="text-muted">Nessun evento in programma.</p>
        {% endif %}
    </div>

    <!-- Modale Dettaglio Evento -->
    <div class="modal fade" id="eventDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header d-flex">
                    <div>
                        <h5 class="modal-title" id="modalTitle"></h5>
                    </div>
                    <div class="ms-auto text-end">
                        <div id="modalDate" class="fw-semibold"></div>
                        <div id="modalTime" class="small"></div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Categorie:</strong> <span id="modalCategories"></span></p>
                    <p><strong>Allenatori:</strong> <span id="modalCoaches"></span></p>
                    <p><strong>Ricorrente:</strong> <span id="modalRecurrence"></span></p>
                </div>
                <div class="modal-footer d-flex">
                    <div id="attendanceActions" class="me-auto d-none">
                        <button type="button" class="btn btn-sm btn-outline-success" id="btnPresent">Presente</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="btnAbsent">Assente</button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-4">

    <div class="row g-4">
        <!-- Card Allenamenti -->
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">üóìÔ∏è Allenamenti</h5>
                    <p class="card-text">Visualizza il calendario, la lista e gestisci gli allenamenti.</p>
                    <div class="mt-auto pt-3">
                        <a href="/calendario" class="btn btn-primary">Vai agli Allenamenti</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Rubrica -->
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">üìñ Rubrica</h5>
                    <p class="card-text">Consulta l'elenco di tutti i soci della canottieri.</p>
                    <div class="mt-auto pt-3">
                        <a href="/rubrica" class="btn btn-primary">Apri la Rubrica</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Gestione Turni (Solo per Admin) -->
        {% if current_user.is_admin %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border border-info border-2" style="cursor: pointer;" onclick="window.location.href='/turni';">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">üïí Turni</h5>
                    <p class="card-text">Assegna gli allenatori ai turni di apertura e chiusura della societ√†.</p>
                    <div class="mt-auto pt-3">
                        <a href="/turni" class="btn btn-primary">Gestisci Turni</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Card Risorse -->
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">üö£ Risorse</h5>
                    <p class="card-text">Gestisci le imbarcazioni e le schede pesi degli atleti.</p>
                    <div class="mt-auto pt-3">
                        <a href="/risorse/barche" class="btn btn-primary me-2">Barche</a>
                        <a href="/risorse/pesi" class="btn btn-primary">Pesi</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Gestione Utenti (Solo per Admin) -->
        {% if current_user.is_admin %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-warning">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">üë• Utenti</h5>
                    <p class="card-text">Aggiungi, modifica o rimuovi utenti dal sistema.</p>
                    <div class="mt-auto pt-3">
                        <a href="/admin/users" class="btn btn-warning">Gestisci Utenti</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='js/attendance_self.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const isAtleta = {{ current_user.is_atleta | tojson }};
    const modalEl = document.getElementById('eventDetailModal');
    if (!modalEl) return;
    const modal = new bootstrap.Modal(modalEl);
    const modalTitle = document.getElementById('modalTitle');
    const modalDate = document.getElementById('modalDate');
    const modalTime = document.getElementById('modalTime');
    const modalCategories = document.getElementById('modalCategories');
    const modalCoaches = document.getElementById('modalCoaches');
    const modalRecurrence = document.getElementById('modalRecurrence');
    const attendanceActions = document.getElementById('attendanceActions');
    const btnPresent = document.getElementById('btnPresent');
    const btnAbsent = document.getElementById('btnAbsent');
    let currentTrainingId = null;
    let currentEventEl = null;

    function updateButtons(status) {
        btnPresent.classList.remove('btn-success','btn-outline-success','active');
        btnAbsent.classList.remove('btn-danger','btn-outline-danger','active');
        if (status === 'present') {
            btnPresent.classList.add('btn-success','active');
            btnAbsent.classList.add('btn-outline-danger');
        } else if (status === 'absent') {
            btnAbsent.classList.add('btn-danger','active');
            btnPresent.classList.add('btn-outline-success');
        } else {
            btnPresent.classList.add('btn-outline-success');
            btnAbsent.classList.add('btn-outline-danger');
        }
    }

    btnPresent.addEventListener('click', async () => {
        try {
            await toggleAttendance(currentTrainingId, 'present');
            updateButtons('present');
            if (currentEventEl) currentEventEl.dataset.status = 'present';
        } catch (err) {
            alert(err.message);
        }
    });
    btnAbsent.addEventListener('click', async () => {
        try {
            await toggleAttendance(currentTrainingId, 'absent');
            updateButtons('absent');
            if (currentEventEl) currentEventEl.dataset.status = 'absent';
        } catch (err) {
            alert(err.message);
        }
    });

    document.querySelectorAll('.dashboard-event').forEach(el => {
        el.addEventListener('click', () => {
            if (el.dataset.link) {
                window.location.href = el.dataset.link;
                return;
            }
            const data = el.dataset;
            currentEventEl = el;
            modalTitle.textContent = data.title;
            modalDate.textContent = data.date;
            modalTime.textContent = data.time;
            modalCategories.textContent = data.categories || '-';
            modalCoaches.textContent = data.coaches || '-';
            modalRecurrence.textContent = data.recurrence || '-';
            if (isAtleta && data.type === 'allenamento') {
                attendanceActions.classList.remove('d-none');
                currentTrainingId = data.id;
                updateButtons(data.status);
                const disable = new Date() >= new Date(data.start);
                btnPresent.disabled = disable;
                btnAbsent.disabled = disable;
            } else {
                attendanceActions.classList.add('d-none');
            }
            modal.show();
        });
    });
});
</script>
{% endblock %}

