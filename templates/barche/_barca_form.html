<ul class="nav nav-tabs mb-4" id="barcaTab" role="tablist">
    <li class="nav-item" role="presentation"><button class="nav-link active" id="generalita-tab" data-bs-toggle="tab" data-bs-target="#generalita" type="button" role="tab">Generalità</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="assegnazione-tab" data-bs-toggle="tab" data-bs-target="#assegnazione" type="button" role="tab">Assegnazione</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="stato-tab" data-bs-toggle="tab" data-bs-target="#stato" type="button" role="tab">Stato Imbarcazione</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="misure-tab" data-bs-toggle="tab" data-bs-target="#misure" type="button" role="tab">Misure</button></li>
</ul>

<div class="tab-content" id="barcaTabContent">
    <div class="tab-pane fade show active" id="generalita" role="tabpanel">
        <div class="mb-3"><label for="nome" class="form-label">Nome*</label><input type="text" id="nome" name="nome" class="form-control" value="{{ barca.nome or '' }}" required></div>
        <div class="mb-3"><label for="tipo" class="form-label">Tipo*</label><select id="tipo" name="tipo" class="form-select" required><option value="" disabled {% if not barca.tipo %}selected{% endif %}>Seleziona...</option>{% set tipi = ["1P 7,20", "1x", "2x", "2-", "2x-", "2+", "4x", "4-", "4x-", "4+", "8+", "Jole 1x", "Jole 2x", "Jole 4x"] %}{% for t in tipi %}<option value="{{ t }}" {% if barca.tipo == t %}selected{% endif %}>{{ t }}</option>{% endfor %}</select></div>
        <div class="row"><div class="col-md-6 mb-3"><label for="costruttore" class="form-label">Costruttore*</label><input type="text" id="costruttore" name="costruttore" class="form-control" value="{{ barca.costruttore or '' }}" required></div><div class="col-md-6 mb-3"><label for="anno_str" class="form-label">Anno*</label><input type="number" id="anno_str" name="anno_str" class="form-control" value="{{ barca.anno or '' }}" required></div></div>
    </div>
    <div class="tab-pane fade" id="assegnazione" role="tabpanel">
        <div class="mb-3"><label for="remi_assegnati" class="form-label">Remi Assegnati</label><input type="text" id="remi_assegnati" name="remi_assegnati" class="form-control" placeholder="Es. Coppia Concept2..." value="{{ barca.remi_assegnati or '' }}"></div>
        <div class="mb-3"><label class="form-label">Atleti Assegnati</label><div class="row mb-2"><div class="col-md-6"><label for="category_filter" class="form-label-sm">Filtra per categoria:</label><select id="category_filter" class="form-select form-select-sm"><option value="all">Tutte le categorie</option>{% for categoria in categorie %}<option value="{{ categoria }}">{{ categoria }}</option>{% endfor %}</select></div></div><div id="atleti-container" class="border rounded p-3" style="max-height: 250px; overflow-y: auto;">{% for atleta in atleti %}<div class="form-check" data-category="{{ atleta.category }}"><input class="form-check-input" type="checkbox" name="atleti_ids" value="{{ atleta.id }}" id="atleta_{{ atleta.id }}" {% if atleta.id in assigned_atleta_ids %}checked{% endif %}><label class="form-check-label" for="atleta_{{ atleta.id }}">{{ atleta.last_name }} {{ atleta.first_name }} <small class="text-muted">({{ atleta.category }})</small></label></div>{% endfor %}</div></div>
    </div>
    <div class="tab-pane fade" id="stato" role="tabpanel">
        <div class="row p-3 border rounded">
            <div class="col-md-6"><div class="form-check form-switch my-2"><input class="form-check-input status-check" type="checkbox" name="in_manutenzione" id="in_manutenzione" value="true" {% if barca.in_manutenzione %}checked{% endif %}> <label class="form-check-label" for="in_manutenzione">In manutenzione</label></div><div class="form-check form-switch my-2"><input class="form-check-input status-check" type="checkbox" name="fuori_uso" id="fuori_uso" value="true" {% if barca.fuori_uso %}checked{% endif %}> <label class="form-check-label" for="fuori_uso">Fuori uso</label></div></div>
            <div class="col-md-6"><div class="form-check form-switch my-2"><input class="form-check-input status-check" type="checkbox" name="in_prestito" id="in_prestito" value="true" {% if barca.in_prestito %}checked{% endif %}> <label class="form-check-label" for="in_prestito">In prestito</label></div><div class="form-check form-switch my-2"><input class="form-check-input status-check" type="checkbox" name="in_trasferta" id="in_trasferta" value="true" {% if barca.in_trasferta %}checked{% endif %}> <label class="form-check-label" for="in_trasferta">In trasferta</label></div></div>
            <div class="col-12 mt-3" id="disponibilita-container" style="display: none;"><label for="disponibile_dal_str" class="form-label">Torna disponibile dal:</label><input type="date" class="form-control" name="disponibile_dal_str" value="{{ barca.disponibile_dal.strftime('%Y-%m-%d') if barca.disponibile_dal else '' }}"></div>
        </div>
    </div>
    <div class="tab-pane fade" id="misure" role="tabpanel">
        <div class="row">
            <div class="col-lg-6 mb-4"><strong class="d-block mb-2 border-bottom pb-1">PUNTAPIEDI</strong><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Lunghezza (cm)</label><input type="number" step="0.1" name="lunghezza_puntapiedi" class="form-control" value="{{ barca.lunghezza_puntapiedi or '' }}"></div><div class="col-md-6 mb-3"><label class="form-label">Altezza (cm)</label><input type="number" step="0.1" name="altezza_puntapiedi" class="form-control" value="{{ barca.altezza_puntapiedi or '' }}"></div></div><strong class="d-block mb-2 mt-3 border-bottom pb-1">CARRELLO</strong><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Altezza (cm)</label><input type="number" step="0.1" name="altezza_carrello" class="form-control" value="{{ barca.altezza_carrello or '' }}"></div><div class="col-md-6 mb-3"><label class="form-label">Avanzamento guide (cm)</label><input type="number" step="0.1" name="avanzamento_guide" class="form-control" value="{{ barca.avanzamento_guide or '' }}"></div></div></div>
            <div class="col-lg-6 mb-4"><strong class="d-block mb-2 border-bottom pb-1">SCALMI</strong><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Apertura totale (cm)</label><input type="number" step="0.1" name="apertura_totale" class="form-control" value="{{ barca.apertura_totale or '' }}"></div><div class="col-md-6 mb-3"><label class="form-label">Altezza SX (cm)</label><input type="number" step="0.1" name="altezza_scalmo_sx" class="form-control" value="{{ barca.altezza_scalmo_sx or '' }}"></div><div class="col-md-6 mb-3"><label class="form-label">Altezza DX (cm)</label><input type="number" step="0.1" name="altezza_scalmo_dx" class="form-control" value="{{ barca.altezza_scalmo_dx or '' }}"></div><div class="col-md-6 mb-3"><label class="form-label">Semiapertura SX (cm)</label><input type="number" step="0.1" name="semiapertura_sx" class="form-control" value="{{ barca.semiapertura_sx or '' }}"></div><div class="col-md-6 mb-3"><label class="form-label">Semiapertura DX (cm)</label><input type="number" step="0.1" name="semiapertura_dx" class="form-control" value="{{ barca.semiapertura_dx or '' }}"></div><div class="col-md-6 mb-3"><label class="form-label">Apprua/appoppa (cm)</label><input type="number" step="0.1" name="appruamento_appoppamento" id="appruamento_input" class="form-control" value="{{ barca.appruamento_appoppamento or '' }}"><div class="form-text">+ appruamento, - appoppamento</div></div></div></div>
            <div class="col-lg-12"><strong class="d-block mb-2 mt-3 border-bottom pb-1">IMPALATURE</strong><div class="row"><div class="col-md-3 mb-3"><label class="form-label">Attacco (°)</label><input type="number" id="gradi_attacco" name="gradi_attacco" class="form-control" value="{{ barca.gradi_attacco or '' }}"></div><div class="col-md-3 mb-3"><label class="form-label">Finale (°)</label><input type="number" id="gradi_finale" name="gradi_finale" class="form-control" value="{{ barca.gradi_finale or '' }}"></div><div class="col-md-3 mb-3"><label class="form-label">Scarto (°)</label><input type="number" id="scarto_gradi" class="form-control" readonly></div></div><div class="row"><div class="col-md-3 mb-3"><label class="form-label">Boccola SX sopra</label><select name="boccola_sx_sopra" class="form-select"><option value="" {% if not barca.boccola_sx_sopra %}selected{% endif %}>--</option>{% for val in ["7-1", "6-2", "5-3", "4-4", "3-5", "2-6", "1-7"] %}<option value="{{ val }}" {% if barca.boccola_sx_sopra == val %}selected{% endif %}>{{ val }}</option>{% endfor %}</select></div><div class="col-md-3 mb-3"><label class="form-label">Boccola DX sopra</label><select name="boccola_dx_sopra" class="form-select"><option value="" {% if not barca.boccola_dx_sopra %}selected{% endif %}>--</option>{% for val in ["7-1", "6-2", "5-3", "4-4", "3-5", "2-6", "1-7"] %}<option value="{{ val }}" {% if barca.boccola_dx_sopra == val %}selected{% endif %}>{{ val }}</option>{% endfor %}</select></div><div class="col-md-3 mb-3"><label class="form-label">Rondelle graduate SX</label><select name="rondelle_sx" class="form-select"><option value="" {% if not barca.rondelle_sx %}selected{% endif %}>--</option>{% for i in range(1, 6) %}<option value="{{ i }} tacchette" {% if barca.rondelle_sx == i|string + ' tacchette' %}selected{% endif %}>{{ i }} tacchetta{{ 'tte' if i > 1 }}</option>{% endfor %}</select></div><div class="col-md-3 mb-3"><label class="form-label">Rondelle graduate DX</label><select name="rondelle_dx" class="form-select"><option value="" {% if not barca.rondelle_dx %}selected{% endif %}>--</option>{% for i in range(1, 6) %}<option value="{{ i }} tacchette" {% if barca.rondelle_dx == i|string + ' tacchette' %}selected{% endif %}>{{ i }} tacchetta{{ 'tte' if i > 1 }}</option>{% endfor %}</select></div></div></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const categoryFilter = document.getElementById('category_filter');
        const atletiContainer = document.getElementById('atleti-container');
        const allAtleti = Array.from(atletiContainer.querySelectorAll('.form-check'));
        categoryFilter.addEventListener('change', function () {
            const selectedCategory = this.value;
            allAtleti.forEach(function (atletaDiv) {
                atletaDiv.style.display = (selectedCategory === 'all' || atletaDiv.dataset.category === selectedCategory) ? 'block' : 'none';
            });
        });

        const gradiAttacco = document.getElementById('gradi_attacco');
        const gradiFinale = document.getElementById('gradi_finale');
        const scartoGradi = document.getElementById('scarto_gradi');
        const appruamentoInput = document.getElementById('appruamento_input');

        function updateScarto() {
            const attacco = parseFloat(gradiAttacco.value) || 0;
            const finale = parseFloat(gradiFinale.value) || 0;
            const scarto = Math.abs(attacco - finale);
            scartoGradi.value = scarto.toFixed(1);
            scartoGradi.classList.toggle('text-danger', scarto > 5);
            scartoGradi.classList.toggle('fw-bold', scarto > 5);
        }

        function checkAppruamento() {
            const valore = parseFloat(appruamentoInput.value);
            appruamentoInput.classList.toggle('text-danger', valore > 10);
            appruamentoInput.classList.toggle('fw-bold', valore > 10);
        }

        gradiAttacco.addEventListener('input', updateScarto);
        gradiFinale.addEventListener('input', updateScarto);
        appruamentoInput.addEventListener('input', checkAppruamento);

        const statusChecks = document.querySelectorAll('.status-check');
        const disponibilitaContainer = document.getElementById('disponibilita-container');

        function checkStatus() {
            const isAnyChecked = Array.from(statusChecks).some(check => check.checked);
            disponibilitaContainer.style.display = isAnyChecked ? 'block' : 'none';
        }

        statusChecks.forEach(check => check.addEventListener('change', checkStatus));

        updateScarto();
        checkAppruamento();
        checkStatus();
    });
</script>