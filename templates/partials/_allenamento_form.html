<!-- templates/_allenamento_form.html -->
{% set allenamento_data = allenamento or {} %}
{% set selected_categories = selected_category_names or [] %}
{% set grouped = grouped_categories or {} %}
{% set orari = ["7:00-9:00", "8:30-10:30", "9:00-11:00", "10:30-12:00", "17:30-19:30", "18:00-20:00"] %}
{% set personal_start = (allenamento_data.orario.split('-')[0] if allenamento_data.orario and allenamento_data.orario not in orari else '') %}
{% set personal_end = (allenamento_data.orario.split('-')[1] if allenamento_data.orario and allenamento_data.orario not in orari else '') %}

<form method="post" id="allenamentoForm">
    <!-- Tipo, Descrizione, Orario (invariati) -->
    <div class="mb-3">
        <label for="tipo" class="form-label">Tipo di Allenamento</label>
        <select class="form-select" id="tipo" name="tipo" required>
            <option value="" disabled {% if not allenamento_data.tipo %}selected{% endif %}>Seleziona...</option>
            {% set tipi = ["Barca", "Remoergometro", "Pesi", "Circuito", "Corsa", "Altro"] %}
            {% for t in tipi %}
                <option value="{{ t }}" {% if allenamento_data.tipo == t %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="descrizione" class="form-label">Descrizione</label>
        <textarea class="form-control" id="descrizione" name="descrizione" rows="2">{{ allenamento_data.descrizione or '' }}</textarea>
    </div>

    <!-- Orario -->
    <div class="mb-3">
        <label for="orario" class="form-label">Orario</label>
        <select class="form-select" id="orario" name="orario">
            <option value="" disabled {% if not allenamento_data.orario %}selected{% endif %}>Seleziona un orario...</option>
            {% for o in orari %}
                 <option value="{{ o }}" {% if allenamento_data.orario == o %}selected{% endif %}>{{ o }}</option>
            {% endfor %}
            <option value="personalizzato" {% if allenamento_data.orario and allenamento_data.orario not in orari %}selected{% endif %}>Altro (personalizzato)</option>
        </select>
    </div>
    <div class="mb-3" id="orario_personalizzato_wrapper" style="display: none;">
        <div class="row g-2">
            <div class="col">
                <label for="orario_start" class="form-label">Inizio</label>
                <input type="time" class="form-control" id="orario_start" name="orario_start" value="{{ personal_start }}">
            </div>
            <div class="col">
                <label for="orario_end" class="form-label">Fine</label>
                <input type="time" class="form-control" id="orario_end" name="orario_end" value="{{ personal_end }}">
            </div>
        </div>
    </div>

    <!-- Selezione Categorie -->
    <div class="mb-4 p-3 border rounded bg-light">
        <label class="form-label fw-bold">Categorie</label>
        <p class="form-text">Seleziona le categorie di atleti a cui assegnare l'allenamento.</p>
        {% for group_name, cats in grouped.items() %}
        <h6 class="mt-2">{{ group_name }}</h6>
        <div class="row g-2 mb-2">
            {% for category in cats %}
            <div class="col-md-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="category_names" value="{{ category }}" id="cat_{{ category.replace(' ', '_') }}" {% if category in selected_categories %}checked{% endif %}>
                    <label class="form-check-label" for="cat_{{ category.replace(' ', '_') }}">{{ category }}</label>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <div class="mb-3">
        <label for="coach_ids" class="form-label">Allenatori</label>
        <select class="form-select" id="coach_ids" name="coach_ids" multiple size="3">
            {% for coach in available_coaches %}
            <option value="{{ coach.id }}" {% if coach.id in selected_coach_ids %}selected{% endif %}>{{ coach.first_name }} {{ coach.last_name }}</option>
            {% endfor %}
        </select>
        <div class="form-text">Puoi selezionare fino a tre allenatori (opzionale).</div>
    </div>

    <hr class="my-4">

    <!-- Data e Ricorrenza -->
    <div class="row align-items-end">
        <div class="col-md-6 mb-3">
            <label for="data" class="form-label fw-bold">Data di Inizio</label>
            <input type="date" class="form-control" id="data" name="data" value="{{ allenamento_data.data or '' }}" required>
        </div>
        <div class="col-md-6 mb-3">
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="is_recurring" name="is_recurring" value="true">
                <label class="form-check-label" for="is_recurring">Abilita Ricorrenza</label>
            </div>
        </div>
    </div>

    <div id="ricorrenza_fields" style="display: none;" class="p-3 border rounded bg-light mb-3">
        <div class="mb-3">
            <label class="form-label">Giorni della settimana</label>
            <div class="d-flex flex-wrap gap-2">
                {% set days = [('MO','Lunedì'),('TU','Martedì'),('WE','Mercoledì'),('TH','Giovedì'),('FR','Venerdì'),('SA','Sabato'),('SU','Domenica')] %}
                {% for code,label in days %}
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="giorni" id="day_{{ code }}" value="{{ code }}">
                    <label class="form-check-label" for="day_{{ code }}">{{ label }}</label>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="row g-2">
            <div class="col-md-6">
                <label for="recurrence_count" class="form-label">Numero di occorrenze</label>
                <input type="number" class="form-control" id="recurrence_count" name="recurrence_count" min="1">
            </div>
            <div class="col-md-6">
                <label for="recurrence_end_date" class="form-label">Data fine</label>
                <input type="date" class="form-control" id="recurrence_end_date" name="recurrence_end_date">
            </div>
        </div>
        <p class="form-text mt-2">Specificare il numero di occorrenze o una data di fine.</p>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
        <a href="/calendario" class="btn btn-secondary">Annulla</a>
        <button type="submit" class="btn btn-primary">{{ 'Salva Modifiche' if allenamento else 'Crea Allenamento' }}</button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- GESTIONE RICORRENZA (BUGFIX) ---
    const recurringCheckbox = document.getElementById('is_recurring');
    const ricorrenzaFields = document.getElementById('ricorrenza_fields');
    const recurrenceCountInput = document.getElementById('recurrence_count');
    const recurrenceEndInput = document.getElementById('recurrence_end_date');
    const orarioSelect = document.getElementById('orario');
    const personalWrapper = document.getElementById('orario_personalizzato_wrapper');
    const startInput = document.getElementById('orario_start');
    const endInput = document.getElementById('orario_end');
    const coachSelect = document.getElementById('coach_ids');

    function toggleRecurrenceFields() {
        const isChecked = recurringCheckbox.checked;
        ricorrenzaFields.style.display = isChecked ? 'block' : 'none';
        if (recurrenceCountInput) recurrenceCountInput.disabled = !isChecked;
        if (recurrenceEndInput) recurrenceEndInput.disabled = !isChecked;
        if (!isChecked) {
            if (recurrenceCountInput) recurrenceCountInput.value = '';
            if (recurrenceEndInput) recurrenceEndInput.value = '';
        }
    }
    recurringCheckbox.addEventListener('change', toggleRecurrenceFields);
    toggleRecurrenceFields(); // Esegui al caricamento per impostare lo stato iniziale

    function togglePersonal() {
        const isPersonal = orarioSelect.value === 'personalizzato';
        personalWrapper.style.display = isPersonal ? 'block' : 'none';
        if (startInput) startInput.required = isPersonal;
        if (endInput) endInput.required = isPersonal;
    }
    orarioSelect.addEventListener('change', togglePersonal);
    togglePersonal();

    if (coachSelect) {
        coachSelect.addEventListener('change', function() {
            const selected = Array.from(this.selectedOptions);
            if (selected.length > 3) {
                selected.slice(3).forEach(opt => opt.selected = false);
            }
        });
    }

    // Nessuna logica aggiuntiva per le categorie singole
});
</script>
