{% extends "layout/base.html" %}

{% block title %}Gestione Attività{% endblock %}

{% block head_extra %}
<style>
  .filters-section {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
  }
  
  .coverage-progress {
    height: 20px;
    font-size: 0.75rem;
  }
  
  .coverage-100 {
    background-color: #198754;
  }
  
  .coverage-partial {
    background-color: #ffc107;
  }
  
  .coverage-low {
    background-color: #dc3545;
  }
  
  /* Colori badge stato */
  .state-badge {
    font-size: 0.75rem;
  }
  
  .state-bozza { background-color: #6c757d; color: white; }
  .state-da_confermare { background-color: #ffc107; color: black; }
  .state-confermato { background-color: #198754; color: white; }
  .state-rimandata { background-color: #6f42c1; color: white; }
  .state-in_corso { background-color: #ffc107; color: black; }
  .state-completato { background-color: #198754; color: white; }
  .state-annullato { background-color: #dc3545; color: white; }
  
  /* Colori badge pagamento */
  .payment-badge {
    font-size: 0.75rem;
  }
  
  .payment-da_effettuare { background-color: #dc3545; color: white; }
  .payment-da_verificare { background-color: #ffc107; color: black; }
  .payment-confermato { background-color: #198754; color: white; }
  
  /* Barra laterale copertura */
  .coverage-sidebar {
    width: 8px;
    border-radius: 4px 0 0 4px;
    min-height: 100%;
    transition: all 0.3s ease;
  }
  
  .coverage-sidebar.green { background-color: #198754; }
  .coverage-sidebar.yellow { background-color: #ffc107; }
  .coverage-sidebar.red { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Gestione Attività</h1>
        <a href="/attivita/nuova" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Nuova Attività
        </a>
      </div>
      
      <!-- Messaggi di successo/errore -->
      {% if request.query_params.get('message') %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> {{ request.query_params.get('message') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endif %}
      
      <!-- Filtri avanzati -->
      <div class="filters-section">
        <form method="GET" class="row g-3">
          <div class="col-md-2">
            <label for="date_from" class="form-label">Data da</label>
            <input type="date" class="form-control" id="date_from" name="date_from" 
                   value="{{ filters.date_from or '' }}">
          </div>
          <div class="col-md-2">
            <label for="date_to" class="form-label">Data a</label>
            <input type="date" class="form-control" id="date_to" name="date_to" 
                   value="{{ filters.date_to or '' }}">
          </div>
          <div class="col-md-2">
            <label for="type_id" class="form-label">Tipo</label>
            <select class="form-select" id="type_id" name="type_id">
              <option value="">Tutti i tipi</option>
              {% for type in activity_types %}
              <option value="{{ type.id }}" {% if filters.type_id|string == type.id|string %}selected{% endif %}>
                {{ type.name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label for="state" class="form-label">Stato</label>
            <select class="form-select" id="state" name="state">
              <option value="">Tutti gli stati</option>
              <option value="bozza" {% if filters.state == 'bozza' %}selected{% endif %}>Bozza</option>
              <option value="da_confermare" {% if filters.state == 'da_confermare' %}selected{% endif %}>Da confermare</option>
              <option value="confermato" {% if filters.state == 'confermato' %}selected{% endif %}>Confermato</option>
              <option value="rimandata" {% if filters.state == 'rimandata' %}selected{% endif %}>Rimandata</option>
              <option value="in_corso" {% if filters.state == 'in_corso' %}selected{% endif %}>In Corso</option>
              <option value="completato" {% if filters.state == 'completato' %}selected{% endif %}>Completato</option>
              <option value="annullato" {% if filters.state == 'annullato' %}selected{% endif %}>Annullato</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="payment_state" class="form-label">Pagamento</label>
            <select class="form-select" id="payment_state" name="payment_state">
              <option value="">Tutti gli stati</option>
              <option value="da_effettuare" {% if filters.payment_state == 'da_effettuare' %}selected{% endif %}>Da effettuare</option>
              <option value="da_verificare" {% if filters.payment_state == 'da_verificare' %}selected{% endif %}>Da verificare</option>
              <option value="confermato" {% if filters.payment_state == 'confermato' %}selected{% endif %}>Confermato</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="text" class="form-label">Testo</label>
            <input type="text" class="form-control" id="text" name="text" 
                   placeholder="Cerca nel titolo..." value="{{ filters.text or '' }}">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-search"></i> Filtra
            </button>
            <a href="/attivita/gestione" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle"></i> Pulisci
            </a>
          </div>
        </form>
      </div>
      
      <!-- Tabella attività -->
      <div class="card">
        <div class="card-body">
          {% if activities %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th style="width: 8px;"></th>
                  <th>Titolo</th>
                  <th>Tipo</th>
                  <th>Data</th>
                  <th>Stato</th>
                  <th>Copertura</th>
                  <th>Pagamento</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <tbody>
                {% for activity in activities %}
                <tr class="activity-row" data-activity-id="{{ activity.id }}" style="cursor: pointer;">
                  <td>
                    <div class="coverage-sidebar {% if activity.coverage_percentage >= 100 %}green{% elif activity.coverage_percentage > 0 %}yellow{% else %}red{% endif %}"></div>
                  </td>
                  <td>
                    <strong>{{ activity.title }}</strong>
                    {% if activity.short_description %}
                    <br><small class="text-muted">{{ activity.short_description[:50] }}{% if activity.short_description|length > 50 %}...{% endif %}</small>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-primary">{{ activity.activity_type.name }}</span>
                  </td>
                  <td>
                    {{ activity.date.strftime('%d/%m/%Y') }}<br>
                    <small class="text-muted">{{ activity.start_time.strftime('%H:%M') }} - {{ activity.end_time.strftime('%H:%M') }}</small>
                  </td>
                  <td>
                    <span class="badge state-badge state-{{ activity.state }}">
                      {% if activity.state == 'bozza' %}Bozza
                      {% elif activity.state == 'da_confermare' %}Da confermare
                      {% elif activity.state == 'confermato' %}Confermato
                      {% elif activity.state == 'rimandata' %}Rimandata
                      {% elif activity.state == 'in_corso' %}In Corso
                      {% elif activity.state == 'completato' %}Completato
                      {% elif activity.state == 'annullato' %}Annullato
                      {% else %}{{ activity.state }}{% endif %}
                    </span>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="flex-grow-1 me-2">
                        <div class="progress coverage-progress">
                          <div class="progress-bar {% if activity.coverage_percentage >= 100 %}coverage-100{% elif activity.coverage_percentage >= 50 %}coverage-partial{% else %}coverage-low{% endif %}" 
                               role="progressbar" style="width: {{ activity.coverage_percentage }}%">
                            {{ "%.0f"|format(activity.coverage_percentage) }}%
                          </div>
                        </div>
                      </div>
                      <small class="text-muted">{{ activity.total_assigned }}/{{ activity.total_required }}</small>
                    </div>
                  </td>
                  <td>
                    <span class="badge payment-badge payment-{{ activity.payment_state }}">
                      {% if activity.payment_state == 'da_effettuare' %}Da effettuare
                      {% elif activity.payment_state == 'da_verificare' %}Da verificare
                      {% elif activity.payment_state == 'confermato' %}Confermato
                      {% else %}{{ activity.payment_state }}{% endif %}
                    </span>
                    {% if activity.payment_amount %}
                    <br><small class="text-muted">€ {{ "%.2f"|format(activity.payment_amount) }}</small>
                    {% endif %}
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <a href="/attivita/modifica/{{ activity.id }}" class="btn btn-sm btn-outline-warning" title="Modifica" onclick="event.stopPropagation();">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <button type="button" class="btn btn-sm btn-outline-danger" title="Elimina" 
                              onclick="event.stopPropagation(); deleteActivity({{ activity.id }}, '{{ activity.title|replace("'", "\\'")|replace('"', '\\"') }}');">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-calendar-x display-1 text-muted"></i>
            <h5 class="mt-3">Nessuna attività trovata</h5>
            <p class="text-muted">Prova a modificare i filtri o crea una nuova attività.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal conferma eliminazione -->
<div class="modal fade" id="deleteActivityModal" tabindex="-1" aria-labelledby="deleteActivityModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteActivityModalLabel">Conferma eliminazione</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Sei sicuro di voler eliminare l'attività <strong id="deleteActivityTitle"></strong>?</p>
        <p class="text-danger"><small>Questa azione non può essere annullata.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
        <button type="button" class="btn btn-danger" id="btnConfirmDelete">Elimina</button>
      </div>
    </div>
  </div>
</div>

<!-- Include modal dettagli attività -->
{% include 'attivita/_activity_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
function deleteActivity(activityId, activityTitle) {
  document.getElementById('deleteActivityTitle').textContent = activityTitle;
  document.getElementById('btnConfirmDelete').onclick = function() {
    // Implementa la logica di eliminazione
    console.log('Eliminazione attività:', activityId);
    // Qui puoi aggiungere una chiamata AJAX per eliminare l'attività
  };
  
  const modal = new bootstrap.Modal(document.getElementById('deleteActivityModal'));
  modal.show();
}

// Gestione click sulla riga per aprire il popup dell'attività
document.addEventListener('DOMContentLoaded', function() {
  const activityRows = document.querySelectorAll('.activity-row');
  
  activityRows.forEach(row => {
    row.addEventListener('click', function() {
      const activityId = this.dataset.activityId;
      // Apri il modal dei dettagli attività
      openActivityModal(activityId);
    });
  });
});

// Funzione per aprire il modal dei dettagli attività
function openActivityModal(activityId) {
  // Carica i dati dell'attività via AJAX
  fetch(`/api/attivita/${activityId}`)
    .then(response => response.json())
    .then(data => {
      // Popola il modal con i dati dell'attività
      populateActivityModal(data);
      // Mostra il modal
      const modal = new bootstrap.Modal(document.getElementById('activityModal'));
      modal.show();
    })
    .catch(error => {
      console.error('Errore nel caricamento dei dettagli attività:', error);
      // Fallback: reindirizza alla pagina di dettaglio
      window.location.href = `/attivita/dettaglio/${activityId}`;
    });
}

// Funzione per popolare il modal con i dati dell'attività
function populateActivityModal(activity) {
  // Tab Generale
  document.getElementById('activity-title').textContent = activity.title || 'N/A';
  document.getElementById('activity-description').textContent = activity.short_description || 'Nessuna descrizione';
  document.getElementById('activity-date').textContent = new Date(activity.date).toLocaleDateString('it-IT');
  document.getElementById('activity-time').textContent = `${activity.start_time} - ${activity.end_time}`;
  document.getElementById('activity-type').textContent = activity.activity_type?.name || 'N/A';
  document.getElementById('activity-state').textContent = activity.state || 'N/A';
  document.getElementById('activity-participants').textContent = activity.participants_plan || 'N/A';
  document.getElementById('activity-participants-actual').textContent = activity.participants_actual || 'N/A';
  document.getElementById('activity-participants-notes').textContent = activity.participants_notes || 'Nessuna nota';
  
  // Cliente e contatti
  document.getElementById('activity-customer-name').textContent = activity.customer_name || 'N/A';
  document.getElementById('activity-customer-email').textContent = activity.customer_email || 'N/A';
  document.getElementById('activity-contact-name').textContent = activity.contact_name || 'N/A';
  document.getElementById('activity-contact-phone').textContent = activity.contact_phone || 'N/A';
  document.getElementById('activity-contact-email').textContent = activity.contact_email || 'N/A';
  
  // Pulsante modifica
  const editBtn = document.getElementById('btn-edit-activity');
  if (editBtn) {
    editBtn.href = `/attivita/modifica/${activity.id}`;
    editBtn.style.display = 'inline-block';
  }
}
</script>
{% endblock %}
