{% extends "layout/base.html" %}

{% block title %}Gestione Attività{% endblock %}

{% block head_extra %}
<style>
  .filters-section {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
  }
  
  .coverage-progress {
    height: 20px;
    font-size: 0.75rem;
  }
  
  .coverage-100 {
    background-color: #198754;
  }
  
  .coverage-partial {
    background-color: #ffc107;
  }
  
  .coverage-low {
    background-color: #dc3545;
  }
  
  .state-badge {
    font-size: 0.75rem;
  }
  
  .state-bozza { background-color: #6c757d; }
  .state-da_confermare { background-color: #ffc107; color: black; }
  .state-confermata { background-color: #198754; }
  .state-rimandata { background-color: #0dcaf0; color: black; }
  .state-annullata { background-color: #dc3545; }
  .state-completata { background-color: #0d6efd; }
  
  .payment-badge {
    font-size: 0.75rem;
  }
  
  .payment-da_effettuare { background-color: #dc3545; }
  .payment-da_verificare { background-color: #ffc107; color: black; }
  .payment-confermato { background-color: #198754; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Gestione Attività</h1>
        <a href="/attivita/nuova" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Nuova Attività
        </a>
      </div>
      
      <!-- Filtri avanzati -->
      <div class="filters-section">
        <form method="GET" class="row g-3">
          <div class="col-md-2">
            <label for="date_from" class="form-label">Data da</label>
            <input type="date" class="form-control" id="date_from" name="date_from" 
                   value="{{ filters.date_from or '' }}">
          </div>
          <div class="col-md-2">
            <label for="date_to" class="form-label">Data a</label>
            <input type="date" class="form-control" id="date_to" name="date_to" 
                   value="{{ filters.date_to or '' }}">
          </div>
          <div class="col-md-2">
            <label for="type_id" class="form-label">Tipo</label>
            <select class="form-select" id="type_id" name="type_id">
              <option value="">Tutti i tipi</option>
              {% for type in activity_types %}
              <option value="{{ type.id }}" {% if filters.type_id|string == type.id|string %}selected{% endif %}>
                {{ type.name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label for="state" class="form-label">Stato</label>
            <select class="form-select" id="state" name="state">
              <option value="">Tutti gli stati</option>
              <option value="bozza" {% if filters.state == 'bozza' %}selected{% endif %}>Bozza</option>
              <option value="da_confermare" {% if filters.state == 'da_confermare' %}selected{% endif %}>Da confermare</option>
              <option value="confermata" {% if filters.state == 'confermata' %}selected{% endif %}>Confermata</option>
              <option value="rimandata" {% if filters.state == 'rimandata' %}selected{% endif %}>Rimandata</option>
              <option value="annullata" {% if filters.state == 'annullata' %}selected{% endif %}>Annullata</option>
              <option value="completata" {% if filters.state == 'completata' %}selected{% endif %}>Completata</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="payment_state" class="form-label">Pagamento</label>
            <select class="form-select" id="payment_state" name="payment_state">
              <option value="">Tutti gli stati</option>
              <option value="da_effettuare" {% if filters.payment_state == 'da_effettuare' %}selected{% endif %}>Da effettuare</option>
              <option value="da_verificare" {% if filters.payment_state == 'da_verificare' %}selected{% endif %}>Da verificare</option>
              <option value="confermato" {% if filters.payment_state == 'confermato' %}selected{% endif %}>Confermato</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="text" class="form-label">Testo</label>
            <input type="text" class="form-control" id="text" name="text" 
                   placeholder="Cerca nel titolo..." value="{{ filters.text or '' }}">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-search"></i> Filtra
            </button>
            <a href="/attivita/gestione" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle"></i> Pulisci
            </a>
          </div>
        </form>
      </div>
      
      <!-- Tabella attività -->
      <div class="card">
        <div class="card-body">
          {% if activities %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Titolo</th>
                  <th>Tipo</th>
                  <th>Data</th>
                  <th>Stato</th>
                  <th>Copertura</th>
                  <th>Pagamento</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <tbody>
                {% for activity in activities %}
                <tr>
                  <td>
                    <strong>{{ activity.title }}</strong>
                    {% if activity.short_description %}
                    <br><small class="text-muted">{{ activity.short_description[:50] }}{% if activity.short_description|length > 50 %}...{% endif %}</small>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-secondary">{{ activity.activity_type.name }}</span>
                  </td>
                  <td>
                    {{ activity.date.strftime('%d/%m/%Y') }}<br>
                    <small class="text-muted">{{ activity.start_time.strftime('%H:%M') }} - {{ activity.end_time.strftime('%H:%M') }}</small>
                  </td>
                  <td>
                    <span class="badge state-badge state-{{ activity.state }}">
                      {% if activity.state == 'bozza' %}Bozza
                      {% elif activity.state == 'da_confermare' %}Da confermare
                      {% elif activity.state == 'confermata' %}Confermata
                      {% elif activity.state == 'rimandata' %}Rimandata
                      {% elif activity.state == 'annullata' %}Annullata
                      {% elif activity.state == 'completata' %}Completata
                      {% else %}{{ activity.state }}{% endif %}
                    </span>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="flex-grow-1 me-2">
                        <div class="progress coverage-progress">
                          <div class="progress-bar {% if activity.coverage_percentage >= 100 %}coverage-100{% elif activity.coverage_percentage >= 50 %}coverage-partial{% else %}coverage-low{% endif %}" 
                               role="progressbar" style="width: {{ activity.coverage_percentage }}%">
                            {{ activity.coverage_percentage }}%
                          </div>
                        </div>
                      </div>
                      <small class="text-muted">{{ activity.total_assigned }}/{{ activity.total_required }}</small>
                    </div>
                  </td>
                  <td>
                    <span class="badge payment-badge payment-{{ activity.payment_state }}">
                      {% if activity.payment_state == 'da_effettuare' %}Da effettuare
                      {% elif activity.payment_state == 'da_verificare' %}Da verificare
                      {% elif activity.payment_state == 'confermato' %}Confermato
                      {% else %}{{ activity.payment_state }}{% endif %}
                    </span>
                    {% if activity.payment_amount %}
                    <br><small class="text-muted">€ {{ "%.2f"|format(activity.payment_amount) }}</small>
                    {% endif %}
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="/attivita/dettaglio/{{ activity.id }}" class="btn btn-outline-primary" title="Visualizza dettagli">
                        <i class="bi bi-eye"></i>
                      </a>
                      <a href="/attivita/dettaglio/{{ activity.id }}" class="btn btn-outline-secondary" title="Modifica">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <button type="button" class="btn btn-outline-danger" title="Elimina" 
                              onclick="deleteActivity({{ activity.id }}, '{{ activity.title }}')">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-calendar-x display-1 text-muted"></i>
            <h5 class="mt-3">Nessuna attività trovata</h5>
            <p class="text-muted">Prova a modificare i filtri o crea una nuova attività.</p>
            <a href="/attivita/nuova" class="btn btn-primary">
              <i class="bi bi-plus-circle"></i> Crea la prima attività
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal conferma eliminazione -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Conferma eliminazione</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Sei sicuro di voler eliminare l'attività <strong id="deleteActivityTitle"></strong>?</p>
        <p class="text-danger"><small>Questa azione non può essere annullata.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">Elimina</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let activityToDelete = null;

function deleteActivity(activityId, activityTitle) {
    activityToDelete = activityId;
    document.getElementById('deleteActivityTitle').textContent = activityTitle;
    
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}

document.getElementById('confirmDelete').addEventListener('click', async function() {
    if (!activityToDelete) return;
    
    try {
        const response = await fetch(`/api/attivita/${activityToDelete}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // Ricarica la pagina per aggiornare la lista
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Errore nell\'eliminazione: ' + (error.detail || 'Errore sconosciuto'));
        }
    } catch (error) {
        console.error('Errore nell\'eliminazione:', error);
        alert('Errore nell\'eliminazione dell\'attività');
    }
    
    // Chiudi il modal
    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
    deleteModal.hide();
});
</script>
{% endblock %}
