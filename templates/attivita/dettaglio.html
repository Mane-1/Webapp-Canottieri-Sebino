{% extends "layout/base.html" %}

{% block title %}Dettaglio Attività{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">{{ activity.title }}</h1>
        <div>
          <a href="/attivita/gestione" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Torna alla lista
          </a>
          <a href="/attivita/dettaglio/{{ activity.id }}" class="btn btn-primary">
            <i class="bi bi-pencil"></i> Modifica
          </a>
        </div>
      </div>
      
      <!-- Tabs -->
      <ul class="nav nav-tabs" id="activityTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="generale-tab" data-bs-toggle="tab" data-bs-target="#generale" type="button" role="tab">
            Generale
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="copertura-tab" data-bs-toggle="tab" data-bs-target="#copertura" type="button" role="tab">
            Copertura
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="risorse-tab" data-bs-toggle="tab" data-bs-target="#risorse" type="button" role="tab">
            Risorse
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="pagamento-tab" data-bs-toggle="tab" data-bs-target="#pagamento" type="button" role="tab">
            Pagamento
          </button>
        </li>
      </ul>
      
      <!-- Contenuto tabs -->
      <div class="tab-content mt-3" id="activityTabsContent">
        <!-- Tab Generale -->
        <div class="tab-pane fade show active" id="generale" role="tabpanel">
          <div class="row">
            <div class="col-md-8">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Informazioni Generali</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Data:</strong> {{ activity.date.strftime('%d/%m/%Y') }}</p>
                      <p><strong>Orario:</strong> {{ activity.start_time.strftime('%H:%M') }} - {{ activity.end_time.strftime('%H:%M') }}</p>
                      <p><strong>Tipo:</strong> <span class="badge bg-secondary">{{ activity.activity_type.name }}</span></p>
                      <p><strong>Stato:</strong> 
                        <span class="badge {% if activity.state == 'bozza' %}bg-secondary{% elif activity.state == 'da_confermare' %}bg-warning text-dark{% elif activity.state == 'confermata' %}bg-success{% elif activity.state == 'rimandata' %}bg-info text-dark{% elif activity.state == 'annullata' %}bg-danger{% else %}bg-primary{% endif %}">
                          {{ activity.state|title }}
                        </span>
                      </p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Partecipanti previsti:</strong> {{ activity.participants_plan or 'N/A' }}</p>
                      <p><strong>Partecipanti effettivi:</strong> {{ activity.participants_actual or 'N/A' }}</p>
                      <p><strong>Note partecipanti:</strong> {{ activity.participants_notes or 'Nessuna nota' }}</p>
                    </div>
                  </div>
                  
                  {% if activity.short_description %}
                  <hr>
                  <h6>Descrizione</h6>
                  <p>{{ activity.short_description }}</p>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Cliente</h5>
                  <p><strong>{{ activity.customer_name or 'N/A' }}</strong></p>
                  <p>{{ activity.customer_email or 'N/A' }}</p>
                  
                  <hr>
                  
                  <h6>Contatti</h6>
                  <p><strong>{{ activity.contact_name or 'N/A' }}</strong></p>
                  <p>{{ activity.contact_phone or 'N/A' }}</p>
                  <p>{{ activity.contact_email or 'N/A' }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tab Copertura -->
        <div class="tab-pane fade" id="copertura" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Requisiti e Assegnazioni</h5>
                <div class="coverage-summary">
                  <span class="badge {% if activity.coverage_percentage >= 100 %}bg-success{% elif activity.coverage_percentage >= 50 %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                    {{ activity.total_assigned }}/{{ activity.total_required }} ({{ activity.coverage_percentage }}%)
                  </span>
                </div>
              </div>
              
              {% if activity.requirements %}
                {% for requirement in activity.requirements %}
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h6 class="card-title">{{ requirement.qualification_type.name }}</h6>
                        <p class="card-text">Quantità richiesta: {{ requirement.quantity }}</p>
                      </div>
                      <div class="text-end">
                        <span class="badge {% if requirement.assigned_count >= requirement.quantity %}bg-success{% elif requirement.assigned_count > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                          {{ requirement.assigned_count }}/{{ requirement.quantity }}
                        </span>
                        <div class="mt-2">
                          <button type="button" class="btn btn-sm btn-outline-primary" onclick="showAddAssignmentModal({{ requirement.id }})">
                            <i class="bi bi-person-plus"></i> Aggiungi
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <div class="assignments-list mt-3">
                      <h6>Assegnazioni:</h6>
                      {% set relevant_assignments = activity.assignments|selectattr('requirement_id', 'equalto', requirement.id)|list %}
                      {% if relevant_assignments %}
                        {% for assignment in relevant_assignments %}
                        <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded mb-1">
                          <div>
                            <i class="bi bi-person-circle"></i>
                            <span>{{ assignment.user.full_name }}</span>
                            {% if assignment.role_label %}
                            <small class="text-muted">({{ assignment.role_label }})</small>
                            {% endif %}
                          </div>
                          <div>
                            <span class="badge bg-secondary">{{ assignment.hours or 0 }}h</span>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick="removeAssignment({{ assignment.id }})">
                              <i class="bi bi-x"></i>
                            </button>
                          </div>
                        </div>
                        {% endfor %}
                      {% else %}
                        <p class="text-muted">Nessuna assegnazione</p>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="text-center py-5">
                  <i class="bi bi-people display-1 text-muted"></i>
                  <h5 class="mt-3">Nessun requisito specificato</h5>
                  <p class="text-muted">Aggiungi requisiti per questa attività.</p>
                  <button type="button" class="btn btn-primary" onclick="showAddRequirementModal()">
                    <i class="bi bi-plus-circle"></i> Aggiungi Requisito
                  </button>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Tab Risorse -->
        <div class="tab-pane fade" id="risorse" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                Gestione risorse materiali (barche, kayak, veicoli) sarà disponibile nella Fase 2.
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <h6>Barche necessarie</h6>
                  <p class="text-muted">Nessuna barca specificata</p>
                </div>
                <div class="col-md-6">
                  <h6>Attrezzature</h6>
                  <p class="text-muted">Nessuna attrezzatura specificata</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tab Pagamento -->
        <div class="tab-pane fade" id="pagamento" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h5>Dettagli Pagamento</h5>
                  <table class="table">
                    <tr>
                      <td><strong>Importo:</strong></td>
                      <td>{% if activity.payment_amount %}€ {{ "%.2f"|format(activity.payment_amount) }}{% else %}N/A{% endif %}</td>
                    </tr>
                    <tr>
                      <td><strong>Metodo:</strong></td>
                      <td>{{ activity.payment_method or 'N/A' }}</td>
                    </tr>
                    <tr>
                      <td><strong>Stato:</strong></td>
                      <td>
                        <span class="badge {% if activity.payment_state == 'da_effettuare' %}bg-danger{% elif activity.payment_state == 'da_verificare' %}bg-warning text-dark{% else %}bg-success{% endif %}">
                          {{ activity.payment_state|title }}
                        </span>
                      </td>
                    </tr>
                  </table>
                </div>
                <div class="col-md-6">
                  <h5>Fatturazione</h5>
                  <table class="table">
                    <tr>
                      <td><strong>Nome:</strong></td>
                      <td>{{ activity.billing_name or 'N/A' }}</td>
                    </tr>
                    <tr>
                      <td><strong>P.IVA/CF:</strong></td>
                      <td>{{ activity.billing_vat_or_cf or 'N/A' }}</td>
                    </tr>
                    <tr>
                      <td><strong>SDI/PEC:</strong></td>
                      <td>{{ activity.billing_sdi_or_pec or 'N/A' }}</td>
                    </tr>
                    <tr>
                      <td><strong>Indirizzo:</strong></td>
                      <td>{{ activity.billing_address or 'N/A' }}</td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Funzioni per la gestione delle assegnazioni e requisiti
// Queste saranno implementate nel JavaScript separato per la gestione amministrativa
</script>
{% endblock %}
